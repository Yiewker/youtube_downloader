name: Build and Release YouTube Downloader

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€vå¼€å¤´çš„tagæ—¶è§¦å‘ï¼Œå¦‚v2.1, v2.2ç­‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸åˆ›å»ºreleaseå’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install pyyaml tkinterdnd2 requests
        
    - name: Build executable
      run: |
        pyinstaller --onefile --windowed --name="YouTube_Downloader_${{ github.ref_name }}" --add-data="yt-dlp.exe;." --add-data="youtube_downloader_config.yaml;." --hidden-import="yaml" --hidden-import="tkinterdnd2" --hidden-import="requests" --exclude-module="matplotlib" --exclude-module="numpy" --exclude-module="scipy" --exclude-module="pandas" youtube_downloader.py
        
    - name: Get file info
      id: file_info
      run: |
        $file_path = "dist/YouTube_Downloader_${{ github.ref_name }}.exe"
        $file_size = (Get-Item $file_path).Length
        $file_size_mb = [math]::Round($file_size / 1MB, 1)
        echo "file_size_mb=$file_size_mb" >> $env:GITHUB_OUTPUT
        echo "file_path=$file_path" >> $env:GITHUB_OUTPUT
        
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: YouTube Downloader ${{ github.ref_name }}
        body: |
          ## ğŸ‰ YouTube Downloader ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½
          - **Windowsç‹¬ç«‹exe**: `YouTube_Downloader_${{ github.ref_name }}.exe` (~${{ steps.file_info.outputs.file_size_mb }}MB)
          - æ— éœ€å®‰è£…Pythonç¯å¢ƒï¼ŒåŒå‡»å³å¯è¿è¡Œ
          - é¦–æ¬¡è¿è¡Œä¼šåœ¨exeåŒç›®å½•ç”Ÿæˆé…ç½®æ–‡ä»¶
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - ğŸ¯ **ç›´æ¥è¾“å…¥é“¾æ¥**ï¼šæ— éœ€åˆ›å»ºtxtæ–‡ä»¶
          - ğŸ“± **ä½ç”»è´¨é€‰é¡¹**ï¼šèŠ‚çœæµé‡å’Œæ—¶é—´
          - âš¡ **ç§’å¼€å¯åŠ¨**ï¼šä»£ç†æµ‹è¯•é»˜è®¤å…³é—­
          - ğŸ”§ **æ™ºèƒ½é‡è¯•**ï¼šè‡ªåŠ¨å¤„ç†ä¸‹è½½å¤±è´¥
          - ğŸ¨ **å‹å¥½ç•Œé¢**ï¼šæ‹–æ‹½æ–‡ä»¶ã€å®æ—¶è¿›åº¦æ˜¾ç¤º
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½exeæ–‡ä»¶
          2. åŒå‡»è¿è¡Œ
          3. è¾“å…¥YouTubeé“¾æ¥æˆ–é€‰æ‹©txtæ–‡ä»¶
          4. ç‚¹å‡»å¼€å§‹ä¸‹è½½
          
          ### ğŸ“ æ›´æ–°å†…å®¹
          è¯¦è§commitå†å²å’ŒREADMEæ–‡æ¡£ã€‚
          
        draft: false
        prerelease: false
        
    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ${{ steps.file_info.outputs.file_path }}
        asset_name: YouTube_Downloader_${{ github.ref_name }}.exe
        asset_content_type: application/octet-stream
        
    - name: Upload config template
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: youtube_downloader_config.yaml
        asset_name: youtube_downloader_config.yaml
        asset_content_type: text/yaml
