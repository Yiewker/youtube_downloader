name: Build and Release YouTube Downloader

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€vå¼€å¤´çš„tagæ—¶è§¦å‘ï¼Œå¦‚v2.1, v2.2ç­‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸åˆ›å»ºreleaseå’Œä¸Šä¼ æ–‡ä»¶

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: YouTube Downloader ${{ github.ref_name }}
        body: |
          ## ðŸŽ‰ YouTube Downloader ${{ github.ref_name }}

          ### ðŸ“¦ ä¸‹è½½é€‰æ‹©
          - **Windowsç‹¬ç«‹exe**: `YouTube_Downloader_${{ github.ref_name }}.exe`
          - **macOSç‹¬ç«‹åº”ç”¨**: `YouTube_Downloader_${{ github.ref_name }}_macos.app`
          - **é…ç½®æ¨¡æ¿**: `youtube_downloader_config.yaml`

          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - ðŸŽ¯ **ç›´æŽ¥è¾“å…¥é“¾æŽ¥**ï¼šæ— éœ€åˆ›å»ºtxtæ–‡ä»¶
          - ðŸ“± **ä½Žç”»è´¨é€‰é¡¹**ï¼šèŠ‚çœæµé‡å’Œæ—¶é—´
          - âš¡ **ç§’å¼€å¯åŠ¨**ï¼šä»£ç†æµ‹è¯•é»˜è®¤å…³é—­
          - ðŸ”§ **æ™ºèƒ½é‡è¯•**ï¼šè‡ªåŠ¨å¤„ç†ä¸‹è½½å¤±è´¥
          - ðŸŽ¨ **å‹å¥½ç•Œé¢**ï¼šæ‹–æ‹½æ–‡ä»¶ã€å®žæ—¶è¿›åº¦æ˜¾ç¤º
          - ðŸŒ **è·¨å¹³å°æ”¯æŒ**ï¼šWindowså’ŒmacOSåŽŸç”Ÿåº”ç”¨

          ### ðŸš€ ä½¿ç”¨æ–¹æ³•

          **Windowsç”¨æˆ·:**
          1. ä¸‹è½½ `YouTube_Downloader_${{ github.ref_name }}.exe`
          2. åŒå‡»è¿è¡Œ

          **macOSç”¨æˆ·:**
          1. ä¸‹è½½ `YouTube_Downloader_${{ github.ref_name }}_macos.app`
          2. åœ¨ç»ˆç«¯ä¸­è¿è¡Œ: `chmod +x YouTube_Downloader_${{ github.ref_name }}_macos.app`
          3. åŒå‡»è¿è¡Œæˆ–ç»ˆç«¯æ‰§è¡Œ: `./YouTube_Downloader_${{ github.ref_name }}_macos.app`

          ### ðŸ“ æ›´æ–°å†…å®¹
          è¯¦è§commitåŽ†å²å’ŒREADMEæ–‡æ¡£ã€‚

        draft: false
        prerelease: false

  build:
    needs: create-release
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            executable_name: YouTube_Downloader_${{ github.ref_name }}.exe
            asset_name: YouTube_Downloader_${{ github.ref_name }}.exe
            build_args: --onefile --windowed
          - os: macos-latest
            platform: macos
            executable_name: YouTube_Downloader_${{ github.ref_name }}_macos.app
            asset_name: YouTube_Downloader_${{ github.ref_name }}_macos.app
            build_args: --onefile --windowed

    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies (Windows)
      if: matrix.platform == 'windows'
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install pyyaml tkinterdnd2 requests

    - name: Install dependencies (macOS)
      if: matrix.platform == 'macos'
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install pyyaml tkinterdnd2 requests

    - name: Download yt-dlp for macOS
      if: matrix.platform == 'macos'
      run: |
        curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp_macos -o yt-dlp
        chmod +x yt-dlp

    - name: Build executable (Windows)
      if: matrix.platform == 'windows'
      run: |
        pyinstaller ${{ matrix.build_args }} --name="${{ matrix.executable_name }}" --add-data="yt-dlp.exe;." --add-data="youtube_downloader_config.yaml;." --hidden-import="yaml" --hidden-import="tkinterdnd2" --hidden-import="requests" --exclude-module="matplotlib" --exclude-module="numpy" --exclude-module="scipy" --exclude-module="pandas" youtube_downloader.py

    - name: Build executable (macOS)
      if: matrix.platform == 'macos'
      run: |
        pyinstaller ${{ matrix.build_args }} --name="YouTube_Downloader_${{ github.ref_name }}_macos" --add-data="yt-dlp:." --add-data="youtube_downloader_config.yaml:." --hidden-import="yaml" --hidden-import="tkinterdnd2" --hidden-import="requests" --exclude-module="matplotlib" --exclude-module="numpy" --exclude-module="scipy" --exclude-module="pandas" youtube_downloader.py
        # é‡å‘½åæ–‡ä»¶æ·»åŠ .appæ‰©å±•å
        mv "dist/YouTube_Downloader_${{ github.ref_name }}_macos" "dist/YouTube_Downloader_${{ github.ref_name }}_macos.app"
        
    - name: Get file info (Windows)
      if: matrix.platform == 'windows'
      id: file_info_windows
      run: |
        $file_path = "dist/${{ matrix.executable_name }}"
        $file_size = (Get-Item $file_path).Length
        $file_size_mb = [math]::Round($file_size / 1MB, 1)
        echo "file_size_mb=$file_size_mb" >> $env:GITHUB_OUTPUT
        echo "file_path=$file_path" >> $env:GITHUB_OUTPUT

    - name: Get file info (macOS)
      if: matrix.platform == 'macos'
      id: file_info_macos
      run: |
        # è°ƒè¯•ï¼šåˆ—å‡ºdistç›®å½•å†…å®¹
        echo "Contents of dist directory:"
        ls -la dist/

        file_path="dist/${{ matrix.executable_name }}"
        echo "Looking for file: $file_path"

        if [ -f "$file_path" ]; then
          file_size=$(stat -f%z "$file_path")
          file_size_mb=$(echo "scale=1; $file_size / 1048576" | bc)
          echo "file_size_mb=$file_size_mb" >> $GITHUB_OUTPUT
          echo "file_path=$file_path" >> $GITHUB_OUTPUT
          echo "File found and info recorded"
        else
          echo "File not found: $file_path"
          exit 1
        fi

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: dist/${{ matrix.executable_name }}
        asset_name: ${{ matrix.asset_name }}
        asset_content_type: application/octet-stream
        
  upload-config:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Upload config template
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: youtube_downloader_config.yaml
        asset_name: youtube_downloader_config.yaml
        asset_content_type: text/yaml
