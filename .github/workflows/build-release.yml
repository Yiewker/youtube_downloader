name: Build and Release YouTube Downloader

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            executable_name: YouTube_Downloader_${{ github.ref_name }}.exe
            build_args: --onefile --windowed
          - os: macos-latest
            platform: macos
            executable_name: YouTube_Downloader_${{ github.ref_name }}_macos.app
            build_args: --onefile --windowed

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies (Windows)
      if: matrix.platform == 'windows'
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller pyyaml tkinterdnd2 requests

    - name: Install dependencies (macOS)
      if: matrix.platform == 'macos'
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller pyyaml tkinterdnd2 requests

    - name: Download yt-dlp for Windows
      if: matrix.platform == 'windows'
      run: |
        curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe -o yt-dlp.exe

    - name: Download yt-dlp for macOS
      if: matrix.platform == 'macos'
      run: |
        curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp_macos -o yt-dlp
        chmod +x yt-dlp

    - name: Build executable (Windows)
      if: matrix.platform == 'windows'
      run: |
        pyinstaller ${{ matrix.build_args }} --name="${{ matrix.executable_name }}" --add-data="yt-dlp.exe;." --add-data="youtube_downloader_config.yaml;." --hidden-import="yaml" --hidden-import="tkinterdnd2" --hidden-import="requests" --exclude-module="matplotlib" --exclude-module="numpy" --exclude-module="scipy" --exclude-module="pandas" youtube_downloader.py

    - name: Build executable (macOS)
      if: matrix.platform == 'macos'
      run: |
        pyinstaller ${{ matrix.build_args }} --name="YouTube_Downloader_${{ github.ref_name }}_macos" --add-data="yt-dlp:." --add-data="youtube_downloader_config.yaml:." --hidden-import="yaml" --hidden-import="tkinterdnd2" --hidden-import="requests" --exclude-module="matplotlib" --exclude-module="numpy" --exclude-module="scipy" --exclude-module="pandas" youtube_downloader.py
        mv "dist/YouTube_Downloader_${{ github.ref_name }}_macos" "dist/YouTube_Downloader_${{ github.ref_name }}_macos.app"

    - name: Debug file info (macOS)
      if: matrix.platform == 'macos'
      run: |
        echo "Contents of dist directory:"
        ls -la dist/

    - name: Create Release and Upload Assets
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: YouTube Downloader ${{ github.ref_name }}
        body: |
          ## ğŸ‰ YouTube Downloader ${{ github.ref_name }}

          ### ğŸ“¦ ä¸‹è½½é€‰æ‹©
          - **Windowsç‹¬ç«‹exe**: `YouTube_Downloader_${{ github.ref_name }}.exe`
          - **macOSç‹¬ç«‹åº”ç”¨**: `YouTube_Downloader_${{ github.ref_name }}_macos.app`
          - **é…ç½®æ¨¡æ¿**: `youtube_downloader_config.yaml`

          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - ğŸ¯ **ç›´æ¥è¾“å…¥é“¾æ¥**ï¼šæ— éœ€åˆ›å»ºtxtæ–‡ä»¶
          - ğŸ“± **ä½ç”»è´¨é€‰é¡¹**ï¼šèŠ‚çœæµé‡å’Œæ—¶é—´
          - âš¡ **ç§’å¼€å¯åŠ¨**ï¼šä»£ç†æµ‹è¯•é»˜è®¤å…³é—­
          - ğŸ”§ **æ™ºèƒ½é‡è¯•**ï¼šè‡ªåŠ¨å¤„ç†ä¸‹è½½å¤±è´¥
          - ğŸ¨ **å‹å¥½ç•Œé¢**ï¼šæ‹–æ‹½æ–‡ä»¶ã€å®æ—¶è¿›åº¦æ˜¾ç¤º
          - ğŸŒ **è·¨å¹³å°æ”¯æŒ**ï¼šWindowså’ŒmacOSåŸç”Ÿåº”ç”¨

          ### ğŸš€ ä½¿ç”¨æ–¹æ³•

          **Windowsç”¨æˆ·:**
          1. ä¸‹è½½ `YouTube_Downloader_${{ github.ref_name }}.exe`
          2. åŒå‡»è¿è¡Œ

          **macOSç”¨æˆ·:**
          1. ä¸‹è½½ `YouTube_Downloader_${{ github.ref_name }}_macos.app`
          2. åœ¨ç»ˆç«¯ä¸­è¿è¡Œ: `chmod +x YouTube_Downloader_${{ github.ref_name }}_macos.app`
          3. åŒå‡»è¿è¡Œæˆ–ç»ˆç«¯æ‰§è¡Œ: `./YouTube_Downloader_${{ github.ref_name }}_macos.app`

          ### ğŸ“ æ›´æ–°å†…å®¹
          è¯¦è§commitå†å²å’ŒREADMEæ–‡æ¡£ã€‚
        files: |
          dist/${{ matrix.executable_name }}
          youtube_downloader_config.yaml
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}